<!DOCTYPE HTML>
<html>
    <head>
        <script type="text/javascript" src="/_core/lib/jquery.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery-ui.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery.layout.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery.cookie.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery.hotkeys.js"></script>
        <script type="text/javascript" src="/_core/lib/jstree/jquery.jstree.js"></script>
        <script type="text/javascript" src="/_core/lib/nvent/core.js"></script>
        <link id="bespin_base" href="/_core/lib/bespin"/>
        <link type="text/css" rel="stylesheet" href="/_core/css/layout-default.css" />
        <link type="text/css" rel="stylesheet" href="/_core/css/jquery-ui/aristo/jquery-ui.css" />
        <link type="text/css" rel="stylesheet" href="/_core/css/ide.css" />
        <script src="/_core/lib/bespin/BespinEmbedded.js"></script>
        <script>
            //var ideEditor = null;
            //var ideEnvironment = null;
            var ideTabStop = 4;
            var bespinReady = false;
            //var contentReady = false;
            //var defaultBespinLoaded = false;
            
            var currentTabId = "";
            var tabIdToTab = {}
            var pathToTab = {}
            var currentTab = null;
            
            function resizeContent(){
                $("#ide-tabs").width($("#content-pane").width());
                $("#" + currentTabId).height($("#content-pane").height()-$("#ide-tabs").outerHeight())
                $("#" + currentTabId).width($("#content-pane").width());
                var tab = currentEditorTab();
                if (tab != null){
                    tab.editor.dimensionsChanged();
                }
                //contentReady = true;
                //loadDefaultBespin();
            }
            /*
            function loadDefaultBespin(){
                if (!defaultBespinLoaded){
                    if (bespinReady && contentReady){
                        attachBespin("ide-editor-0","Hello, world!","html");
                        defaultBespinLoaded = true;
                    }
                }
            }
            */

            function attachBespin(id,content,syntax,callback){
                bespin.useBespin(id,{
                    syntax: syntax
                }).then(function(env) {
                    //ideEnvironment = env;
                    env.settings.set("tabstop",ideTabStop);
                    // Get the editor.
                    //ideEditor = env.editor;
                    // Change the value.
                    env.editor.value = content;
                    if (typeof(callback)!=="undefined"){
                        callback(env);
                    }
                }, function(error) {
                    throw new Error("Launch failed: " + error);
                });
            }
            
            
            window.onBespinLoad = function() {
                bespinReady = true;
                //loadDefaultBespin();
            }
            
            $(function () {
                var outerLayout = $("body").layout({
                    north__size: 55,
                    onresize: function(){
                        //setTimeout(resizeContent,1000);
                        //resizeContent();
                        //if (currentTab != null && typeof(currentTab.editor)!=="undefined"){
                        //    currentTab.editor.dimensionsChanged();
                        //}
                        //ideEditor.dimensionsChanged();
                        //console.log("resize");
                    }
                })
                var innerLayout = $("div.ui-layout-center").layout({
                    center__paneSelector: ".inner-center",
                    south__paneSelector: ".inner-south",
                    onresize: function(){
                        resizeContent();
                    }
                })
                $('#resource-browser').jstree({
                    "core": {
                        "animation": 100
                    },
                    "themes": {
                        "theme": "default",
                        "dots": false,
                        "icons": true
                    },
                    "types" : {
                        "types" : {
                            "default" : {
                                "valid_children" : [ "default" ],
                                //"select_node" : function (e) {this.toggle_node(e);return false;}
                                "select_node": function (n){
                                    //alert(n.attr("path"))
                                    //this.select_node(n)
                                    //alert($(n).parent().attr("path"))
                                    //ideEditor.nventPath = $(n).parent().attr("path");
                                    tabForPath($(n).parent().attr("path"),function(tab){
                                        $("#content-pane").tabs("select",tab.id);
                                        $.getJSON("/_core/file.json?path="+tab.path,function(data){
                                            if (data.result.type === "file"){
                                                var reTabLine = /^ *(\t *)+/mg
                                                var reTab = /\t/g
                                                var tabSpaces = "";
                                                for (var i = 0; i < ideTabStop; i++){
                                                    tabSpaces = tabSpaces + " ";
                                                }
                                                //alert(reTab.test(data.result.content));
                                                var content = data.result.content.replace(reTabLine,function(match){
                                                    return match.replace(reTab,tabSpaces);
                                                });
                                                //alert(content);
                                                if (tab.path.endsWith("js") || tab.path.endsWith("json")){
                                                    tab.editor.syntax = "js";
                                                } else if (tab.path.endsWith("html")){
                                                    tab.editor.syntax = "html";
                                                } else if (tab.path.endsWith("css")){
                                                    tab.editor.syntax = "css";
                                                } else {
                                                    tab.editor.syntax = "";
                                                }
                                                tab.editor.value = content;
                                            } else {
                                                tab.editor.value = "";
                                            }
                                        })
                                    })
                                }
                            }
                        }
                    },
                    "json_data": {
                        "ajax": {
                            "url":"/_core/files.json",
                            "data":function(n){
                                if (n.attr){
                                    return {path:n.attr("path")};
                                } else {
                                    return {}
                                }
                            },
                            "success":function(data){
                                return data.result;
                            }
                        }
                    },
                    "plugins": [
                        "themes",
                        "json_data",
                        "types",
                        "ui",
                        "dnd"
                    ]
                });
                
                $(".server-restart").button().click(function(){
                    $.getJSON("/_core/restart.json",function(data){
                        window.location.reload();
                    })
                })
                
                $(".server-kill").button().click(function(){
                    if (confirm("Are you sure you want to kill the server?")){
                        $.getJSON("/_core/kill.json",function(data){
                            window.location.reload();
                        })
                    }
                })
                
                //$(document).bind('keydown', 'ctrl+s', function(e){
                $(".server-save").button().click(function(){
                    //alert(e)
                    //e.preventDefault();
                    //alert("save!")
                    //alert(ideEditor.value)
                    var tab = currentEditorTab();
                    if (tab != null){
                        $.post("/_core/save.json",{path:tab.path,content:tab.editor.value},function(data){

                        })
                    }
                    return false;
                });
/*
                editor = new bespin.editor.Component('ide-editor', {
                    language		: "html",
                    loadfromdiv 	: false,
                    set 			: {
                        fontsize		: 10,
                        strictlines		: 'on',
                        tabsize 		: 4,
                        highlightline	: 'on',
                        syntaxcheck		: 'on',
                        trimonsave		: 'on',
                        codecomplete	: 'on'
                    }
                });
*/
                //bespin.useBespin("ide-editor")

                /*

*/


                //alert(editor)
                
                $("#content-pane").tabs()
                $("#content-pane").tabs("select",1)
                currentTabId = "ide-editor-0";
                $("#content-pane").tabs({
                    show: function(event, ui) {
                        currentTabId = ui.panel.id;
                        currentTab = tabIdToTab[currentTabId]
                        resizeContent();
                    },
                    remove: function(event, ui) {
                        var tab = tabIdToTab[ui.panel.id];
                        delete tabIdToTab[ui.panel.id];
                        delete pathToTab[tab.path];                        
                    }
                });
                resizeContent();
            });
            
            var ideEditorIndex = 0;
            
            function addEditor(name,content,syntax,callback){
                var tab = {}
                ideEditorIndex++;
                var ideEditorId = "ide-editor-" + ideEditorIndex;
                $("#content-pane").append('<div style="padding: 0px; margin: 0px; border: 0px;" id="' + ideEditorId + '"></div>')
                $("#content-pane").tabs("add","#" + ideEditorId,name);
                //'<span class="removetab ui-icon ui-icon-circle-close" style="float:right; margin: -2px -10px 0px 3px; cursor:pointer;"></span>'
                $("a[href=#" + ideEditorId + "] span").css("float","left")
                var closeIcon = $('<span class="removetab ui-icon ui-icon-circle-close" style="float:right; margin: -2px -10px 0px 3px; cursor:pointer;"></span>');
                $("a[href=#" + ideEditorId + "]").append(closeIcon);
                closeIcon.click(function(){
                    $("#content-pane").tabs("remove",$(this).parent().parent().index());
                })
                $("#content-pane").tabs("select",ideEditorId);
                tab.id = ideEditorId;
                tabIdToTab[ideEditorId] = tab;
                currentTab = tab;
                resizeContent();
                attachBespin(ideEditorId,content,syntax,function(env){
                    tab.editor = env.editor;
                    tab.editor.dimensionsChanged();
                    if (typeof(callback)!=="undefined"){
                        callback(tab);
                    }
                });
            }

            function addEditorAfterBespinLoaded(name,content,syntax,callback){
                if (bespinReady){
                    addEditor(name,content,syntax,callback);
                } else {
                    setTimeout(function(){addEditor(name,content,syntax,callback)},100);
                }
            }

            function tabForPath(path,callback){
                if (path in pathToTab){
                    callback(pathToTab[path]);
                } else {
                    var pathParts = path.split("/")
                    addEditor(pathParts[pathParts.length - 1],"","",function(tab){
                        tab.path = path;
                        pathToTab[path] = tab;
                        callback(tab)
                    })
                }
            }
            
            function currentEditorTab(){
                if (currentTab != null){
                    if (typeof(currentTab.editor)!=="undefined"){
                        return currentTab;
                    }
                }
                return null;
            }


            /*
            window.onBespinLoad = function() {
                var edit = $("#ide-editor")[0];
                // Get the environment variable.
                var env = edit.bespin;
                env.settings.set("tabstop",4);
                //env.settings.set("tabmode","on");
                // Get the editor.
                ideEditor = env.editor;
                // Change the value and move to the secound line.
                //editor.value = "Initial Content\nWith 2 lines";
                //editor.setLineNumber(2);
                //alert(bespin)
            };
            */
        </script>
    </head>
    <body>
        <div class="ui-layout-north">
            <a class="server-restart" href="#">Restart</a>
            <a class="server-kill" href="#">Kill</a>
            <a class="server-save" href="#">Save</a>
        </div>
        <div class="ui-layout-west">
            <div id="resource-browser">
                <ul>
                    <li id="item_1" rel="root">
                        <a href="#">Root node 1</a>
                    </li>
                </ul>
                <ul>
                    <li id="item_2">
                        <a href="#">Child node 1</a>
                    </li>
                </ul>
            </div>
        </div>
        <!--
        <div class="ui-layout-south">
            Nothing here yet!
        </div>
        -->
        <!--<div class="ui-layout-east">East</div>-->
        <div class="ui-layout-center"  style="overflow: hidden; padding: 0px;">
            <div id="content-pane" class="inner-center" style="overflow: hidden; padding: 0px;">
                <!--
                <div id="ide-editor" class="bespin" data-bespinoptions='{ "stealFocus":true, "syntax": "js" }'></div>
                </div>
                -->
                <ul id="ide-tabs" style="padding: 0px;  margin:0px;">
                    <li><a href="#home">Home</a></li>
                    <!--<li><a href="#ide-editor-0">IDE</a></li>-->
                </ul>
                <div style="padding: 0px; margin: 0px; border: 0px;" id="home"><br/>Welcome to the awesome node.js IDE!</div>
                <!--<div style="padding: 0px; margin: 0px; border: 0px;" id="ide-editor-0"></div>-->
            </div>
            <div class="inner-south">
                Debugging goes here.
            </div>
        </div>
    </body>
</html>