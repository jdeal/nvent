<html>
    <head>
        <script type="text/javascript" src="/_core/lib/jquery.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery-ui.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery.layout.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery.cookie.js"></script>
        <script type="text/javascript" src="/_core/lib/jquery.hotkeys.js"></script>
        <script type="text/javascript" src="/_core/lib/jstree/jquery.jstree.js"></script>
        <link id="bespin_base" href="/_core/lib/bespin"/>
        <link type="text/css" rel="stylesheet" href="/_core/css/layout-default.css" />
        <script src="/_core/lib/bespin/BespinEmbedded.js"></script>
        <script>
            var ideEditor = null;
            
            $(function () {
                var layout = $("body").layout()
                $('#resource-browser').jstree({
                    "core": {
                        "animation": 100
                    },
                    "themes": {
                        "theme": "default",
                        "dots": false,
                        "icons": true
                    },
                    "types" : {
                        "types" : {
                            "default" : {
                                "valid_children" : [ "default" ],
                                //"select_node" : function (e) {this.toggle_node(e);return false;}
                                "select_node": function (n){
                                    //alert(n.attr("path"))
                                    //this.select_node(n)
                                    //alert($(n).parent().attr("path"))
                                    ideEditor.nventPath = $(n).parent().attr("path");
                                    $.getJSON("/_core/file.json?path="+$(n).parent().attr("path"),function(data){
                                        if (ideEditor) {
                                            if (data.result.type === "file"){
                                                ideEditor.value = data.result.content;
                                            } else {
                                                ideEditor.value = "";
                                            }
                                        }
                                    })
                                }
                            }
                        }
                    },
                    "json_data": {
                        "ajax": {
                            "url":"/_core/files.json",
                            "data":function(n){
                                if (n.attr){
                                    return {path:n.attr("path")};
                                } else {
                                    return {}
                                }
                            },
                            "success":function(data){
                                return data.result;
                            }
                        }
                    },
                    "plugins": [
                        "themes",
                        "json_data",
                        "types",
                        "ui",
                        "dnd"
                    ]
                });
                
                $(".server-restart").click(function(){
                    $.getJSON("/_core/restart.json",function(data){
                    })
                })
                
                //$(document).bind('keydown', 'ctrl+s', function(e){
                $(".server-save").click(function(){
                    //alert(e)
                    //e.preventDefault();
                    //alert("save!")
                    //alert(ideEditor.value)
                    $.post("/_core/save.json",{path:ideEditor.nventPath,content:ideEditor.value},function(data){
                    
                    })
                    return false;
                });
            });

            window.onBespinLoad = function() {
                var edit = $("#ide-editor")[0];
                // Get the environment variable.
                var env = edit.bespin;
                //env.settings.set("tabstop",4);
                env.settings.set("tabmode","on");
                // Get the editor.
                ideEditor = env.editor;
                // Change the value and move to the secound line.
                //editor.value = "Initial Content\nWith 2 lines";
                //editor.setLineNumber(2);
                //alert(bespin)
            };
        </script>
    </head>
<body>
    <div class="ui-layout-center">
        <div id="ide-editor" class="bespin" data-bespinoptions='{ "stealFocus":true, "syntax": "js" }'></div>
        </div>
        <div class="ui-layout-north">
            <a class="server-restart" href="#">Restart</a>
            <a class="server-save" href="#">Save</a>
        </div>
        <div class="ui-layout-south">South</div>
            <!--<div class="ui-layout-east">East</div>-->
            <div class="ui-layout-west">
                <div id="resource-browser">
                    <ul>
                        <li id="item_1" rel="root">
                            <a href="#">Root node 1</a>
                        </li>
                    </ul>
                    <ul>
                        <li id="item_2">
                            <a href="#">Child node 1</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </body>
</html>